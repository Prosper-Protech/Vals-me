<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Romantic Valentine Gesture Magic</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: radial-gradient(circle at center, #2e0108 0%, #1a0105 100%); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        #video-container { 
            position: fixed; 
            bottom: 15px; 
            right: 15px; 
            width: 180px; 
            height: 135px; 
            border: 3px solid #ff4d6d; 
            border-radius: 12px; 
            overflow: hidden; 
            z-index: 10; 
            transform: scaleX(-1); 
            box-shadow: 0 0 25px rgba(255, 77, 109, 0.7); 
        }
        #webcam-video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        #ui-hint { 
            position: fixed; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            color: white; 
            background: rgba(255, 77, 109, 0.7); 
            padding: 10px 25px; 
            border-radius: 30px; 
            pointer-events: none; 
            font-weight: bold; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            backdrop-filter: blur(5px); 
            box-shadow: 0 0 10px rgba(255, 77, 109, 0.5);
        }
        #valentine-text { 
            position: fixed; 
            top: 45%; 
            left: 50%; 
            transform: translate(-50%, -50%) scale(0); 
            color: #ffb3c1; 
            font-family: 'Great Vibes', cursive; /* Applied romantic font */
            font-size: 6rem; /* Increased size for impact */
            font-weight: 400; /* Great Vibes is not bold */
            text-shadow: 0 0 30px #ff4d6d, 0 0 15px #ff4d6d; /* Enhanced glow */
            pointer-events: none; 
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            text-align: center; 
            width: 90%; /* Allow for wider text */
            line-height: 1; /* Adjust line height for multi-line text */
        }
        /* Style for audio controls if visible, though hidden by default */
        audio {
            display: none; /* Hide default audio player */
        }
    </style>
</head>
<body>

    <div id="ui-hint">ðŸ’– Pinch fingers to send a Valentine message ðŸ’–</div>
    <div id="valentine-text">Will you be my<br>Valentine?</div>
    
    <div id="video-container">
        <video id="webcam-video" autoplay playsinline></video>
    </div>

    <audio id="valentine-music" loop autoplay>
        <source src="https://www.bensound.com/bensound-music/bensound-romantic.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GUI } from 'three/addons/libs/lil-gui.module.min.js'; // Keep GUI for potential debugging

        // --- MediaPipe Hand Detection Setup ---
        const loadScript = (src) => new Promise(res => {
            const s = document.createElement('script'); s.src = src; s.onload = res; document.head.appendChild(s);
        });

        await loadScript("https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js");
        await loadScript("https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js");

        // --- Core Variables ---
        let scene, camera, renderer, particles, geometry, material;
        let particleCount = 30000; // Increased particle count for denser rose effect
        let gestureScale = 1;
        let targetScale = 1;
        const textElement = document.getElementById('valentine-text');
        const audio = document.getElementById('valentine-music');

        const params = {
            color: '#ff2e63', // Deeper red for roses
            particleSize: 0.12, // Slightly larger for petal effect
            rotationSpeed: 0.8
        };

        const heartShape = (i) => {
            const t = (i / particleCount) * Math.PI * 2;
            const x = 16 * Math.pow(Math.sin(t), 3);
            const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
            const z = (Math.random() - 0.5) * 6; // More depth for a cloud of petals
            return [x * 0.35, y * 0.35, z]; // Slightly larger heart overall
        };

        init();
        setupHandTracking();
        animate();

        // Start music on first interaction (browser autoplay policy)
        document.addEventListener('click', () => {
            if (audio.paused) {
                audio.play().catch(e => console.error("Autoplay failed:", e));
            }
        }, { once: true });


        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 18; // Adjusted camera position for larger heart

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            createParticles();

            // Optional: GUI for debugging/tweaking, can be removed for final version
            const gui = new GUI();
            gui.addColor(params, 'color').onChange(v => material.color.set(v));
            gui.add(params, 'particleSize', 0.05, 0.3).onChange(v => material.size = v);
            gui.add(params, 'rotationSpeed', 0, 2);
            gui.add(camera.position, 'z', 10, 50).name('Camera Z');


            window.addEventListener('resize', onWindowResize);
        }

        function createParticles() {
            if (particles) scene.remove(particles); // Remove previous particles if re-creating

            geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            const baseColor = new THREE.Color(params.color);

            for (let i = 0; i < particleCount; i++) {
                const [x, y, z] = heartShape(i);
                positions[i * 3] = x;
                positions[i * 3 + 1] = y;
                positions[i * 3 + 2] = z;

                // Varied rose petal shades: deep reds, pinks, hints of purple
                const mixedColor = baseColor.clone().lerp(new THREE.Color('#ff85a1'), Math.random() * 0.6); // Pinker
                mixedColor.lerp(new THREE.Color('#9e0031'), Math.random() * 0.3); // Deeper red
                colors[i * 3] = mixedColor.r;
                colors[i * 3 + 1] = mixedColor.g;
                colors[i * 3 + 2] = mixedColor.b;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            
            // Create a soft, diffuse texture for particles (like a petal)
            const particleTexture = new THREE.CanvasTexture(
                (() => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 64;
                    canvas.height = 64;
                    const ctx = canvas.getContext('2d');
                    const gradient = ctx.createRadialGradient(
                        canvas.width / 2,
                        canvas.height / 2,
                        0,
                        canvas.width / 2,
                        canvas.height / 2,
                        canvas.width / 2
                    );
                    gradient.addColorStop(0, 'rgba(255,255,255,1)');
                    gradient.addColorStop(0.5, 'rgba(255,255,255,0.8)');
                    gradient.addColorStop(1, 'rgba(255,255,255,0)');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    return canvas;
                })()
            );

            material = new THREE.PointsMaterial({
                size: params.particleSize,
                vertexColors: true,
                transparent: true,
                opacity: 0.9, // Slightly more opaque for petal feel
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                map: particleTexture // Apply the custom texture
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        function setupHandTracking() {
            const videoElement = document.getElementById('webcam-video');
            const hands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.6,
                minTrackingConfidence: 0.6
            });

            hands.onResults((results) => {
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const landmarks = results.multiHandLandmarks[0];
                    const dx = landmarks[4].x - landmarks[8].x;
                    const dy = landmarks[4].y - landmarks[8].y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    
                    targetScale = THREE.MathUtils.mapLinear(distance, 0.03, 0.25, 0.4, 2.2);

                    if (distance < 0.06) { // If pinched closely
                        textElement.style.transform = "translate(-50%, -50%) scale(1)";
                        // Briefly increase music volume or add a sound effect here if desired
                    } else {
                        textElement.style.transform = "translate(-50%, -50%) scale(0)";
                    }
                } else {
                    // If no hand detected, reset text scale
                    textElement.style.transform = "translate(-50%, -50%) scale(0)";
                }
            });

            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => await hands.send({ image: videoElement }),
                width: 640,
                height: 480
            });
            cameraUtils.start();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            gestureScale = THREE.MathUtils.lerp(gestureScale, targetScale, 0.15);
            particles.scale.set(gestureScale, gestureScale, gestureScale);
            
            // Add a constant subtle pulse for the heart
            const pulse = Math.sin(Date.now() * 0.003) * 0.03; // Slower, gentler pulse
            particles.scale.addScalar(pulse);

            particles.rotation.y += 0.004 * params.rotationSpeed; // Slightly slower rotation
            particles.rotation.z += 0.001 * params.rotationSpeed;

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
