<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Romantic Valentine Gesture Magic</title>

    <meta property="og:title" content="A Special Valentine's Surprise ðŸ’–">
    <meta property="og:description" content="Use your hand gestures to see the magic!">
    <meta property="og:image" content="preview.jpg">
    
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: radial-gradient(circle at center, #2e0108 0%, #1a0105 100%); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }

        .video-box {
            position: fixed; 
            bottom: 15px; 
            width: 180px; 
            height: 135px; 
            border: 3px solid #ff4d6d; 
            border-radius: 12px; 
            overflow: hidden; 
            z-index: 10; 
            box-shadow: 0 0 25px rgba(255, 77, 109, 0.7); 
            background: #000;
        }

        #webcam-container { right: 15px; transform: scaleX(-1); }
        #upload-video-container { left: 15px; }

        video { width: 100%; height: 100%; object-fit: cover; }

        #ui-hint { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
            color: white; background: rgba(255, 77, 109, 0.7); 
            padding: 10px 25px; border-radius: 30px; pointer-events: none; 
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px; 
            backdrop-filter: blur(5px); z-index: 20;
        }

        #valentine-text { 
            position: fixed; top: 45%; left: 50%; 
            transform: translate(-50%, -50%) scale(0); 
            color: #ffb3c1; font-family: 'Great Vibes', cursive;
            font-size: 6rem; text-shadow: 0 0 30px #ff4d6d, 0 0 15px #ff4d6d; 
            pointer-events: none; transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            text-align: center; width: 90%; line-height: 1; z-index: 5;
        }

        audio { display: none; }
    </style>
</head>
<body>

    <div id="ui-hint">ðŸ’– Pinch fingers to send a Valentine message ðŸ’–</div>
    <div id="valentine-text">Will you be my<br>Valentine?</div>
    
    <div id="upload-video-container" class="video-box">
        <video id="romance-video" autoplay loop muted playsinline>
            <source src="auto-play.mp4" type="video/mp4">
        </video>
    </div>

    <div id="webcam-container" class="video-box">
        <video id="webcam-video" autoplay playsinline></video>
    </div>

    <!--<audio id="valentine-music" loop>
        <source src="https://www.bensound.com/bensound-music/bensound-romantic.mp3" type="audio/mpeg">
    </audio> -->

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // Helper to load external scripts
        const loadScript = (src) => new Promise(res => {
            const s = document.createElement('script');
            s.src = src;
            s.onload = res;
            document.head.appendChild(s);
        });

        // Global variables
        let scene, camera, renderer, particles, targetScale = 1, gestureScale = 1;
        const textElement = document.getElementById('valentine-text');
        const audio = document.getElementById('valentine-music');

        async function startApp() {
            // 1. Load Libraries first
            await loadScript("https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js");
            await loadScript("https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js");

            // 2. Initialize Three.js
            initThree();
            
            // 3. Initialize Hand Tracking
            setupHandTracking();
            
            // 4. Start Animation Loop
            animate();
        }

        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 18;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // Create Heart Particles
            const particleCount = 30000;
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(particleCount * 3);
            const cols = new Float32Array(particleCount * 3);
            const baseCol = new THREE.Color('#ff2e63');

            for (let i = 0; i < particleCount; i++) {
                const t = (i / particleCount) * Math.PI * 2;
                const x = 16 * Math.pow(Math.sin(t), 3) * 0.35;
                const y = (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * 0.35;
                const z = (Math.random() - 0.5) * 6;
                pos[i*3] = x; pos[i*3+1] = y; pos[i*3+2] = z;
                const mixed = baseCol.clone().lerp(new THREE.Color('#ffb3c1'), Math.random() * 0.6);
                cols[i*3] = mixed.r; cols[i*3+1] = mixed.g; cols[i*3+2] = mixed.b;
            }

            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.BufferAttribute(cols, 3));
            const mat = new THREE.PointsMaterial({ size: 0.12, vertexColors: true, transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending, depthWrite: false });
            particles = new THREE.Points(geo, mat);
            scene.add(particles);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function setupHandTracking() {
            const video = document.getElementById('webcam-video');
            const hands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults((results) => {
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const lm = results.multiHandLandmarks[0];
                    // Calculate distance between Thumb Tip (4) and Index Tip (8)
                    const dist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                    
                    // Map distance to scale
                    targetScale = THREE.MathUtils.mapLinear(dist, 0.03, 0.2, 0.5, 2.5);
                    
                    // Show text if pinched
                    if (dist < 0.05) {
                        textElement.style.transform = "translate(-50%, -50%) scale(1)";
                    } else {
                        textElement.style.transform = "translate(-50%, -50%) scale(0)";
                    }
                }
            });

            const cameraPipe = new Camera(video, {
                onFrame: async () => { await hands.send({image: video}); },
                width: 640,
                height: 480
            });
            cameraPipe.start();
        }

        function animate() {
            requestAnimationFrame(animate);
            gestureScale = THREE.MathUtils.lerp(gestureScale, targetScale, 0.1);
            particles.scale.setScalar(gestureScale + Math.sin(Date.now() * 0.003) * 0.03);
            particles.rotation.y += 0.003;
            renderer.render(scene, camera);
        }

        // Handle Audio and Video unmuting
        document.addEventListener('click', () => {
            audio.play();
            const romanceVid = document.getElementById('romance-video');
            romanceVid.muted = false;
            romanceVid.play();
        }, { once: true });

        // Run the app
        startApp();
    </script>
</body>
</html>
